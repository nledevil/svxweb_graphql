import fs from 'fs';
import ini from './utils/ini';
import sql from './sql';
import sqltables from '../config/sqltables';

const { svxlinkTable } = sqltables;

const version = '1.0.0';

const iniHeader = `# Configuration file for the Svxlink Server\n# GENERATED BY SVXWEB V${version}\n# Written By W9UEY\n# DO NOT EDIT - EDITS WILL BE OVERWRITTEN\n`;

export const readINIConfig = async () => {
  console.log('Reading SVXLINK Config Files');
  const svxConfigFile = fs.readFileSync(`/etc/svxlink/svxlink.conf`, 'utf-8');
  const config = ini.decode(svxConfigFile);

  // console.info('config:', config);
  await sql.delAll(svxlinkTable);
  const results = await sql.batchInsert(svxlinkTable, {
    input: config,
  });
  return results;
};

export const writeINIConfig = async () => {
  try {
    const dbConfig = await sql.get(svxlinkTable);
    const config = ini.encode(dbConfig, iniHeader);
    if (fs.existsSync(`/etc/svxlink/svxlink.conf.bak`)) {
      fs.rmSync(`/etc/svxlink/svxlink.conf.bak`);
    }
    fs.renameSync(`/etc/svxlink/svxlink.conf`, `/etc/svxlink/svxlink.conf.bak`);
    fs.writeFileSync(`/etc/svxlink/svxlink.conf`, config);  
  } catch (err) {
    return err;
  }
  return 'Complete';
}